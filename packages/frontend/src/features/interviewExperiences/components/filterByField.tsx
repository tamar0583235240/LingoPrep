import { useState, useEffect, useMemo } from "react";
import { FaTimes, FaFilter } from 'react-icons/fa';

type FilterState = {
    companyName: string;
    position: string;
    rating: string;
    hasReports: string;
};

type FilterSidebarProps = {
    allInterview: any[];
    contentReports: any[];
    onFilteredResults: (filteredInterviews: any[]) => void;
    isOpen: boolean;
    onClose: () => void;
};

export const FilterByField: React.FC<FilterSidebarProps> = ({
    allInterview,
    contentReports,
    onFilteredResults,
    isOpen,
    onClose
}) => {
    const [filters, setFilters] = useState<FilterState>({
        companyName: '',
        position: '',
        rating: '',
        hasReports: ''
    });

    const hasContentReports = (experienceId: string) => {
        return contentReports && contentReports.some(r => r.experience_id === experienceId);
    };

    const getFilteredInterviews = useMemo(() => {
        if (!allInterview) return [];

        let result = [...allInterview];

        if (filters.companyName) {
            result = result.filter(interview =>
                interview.company_name === filters.companyName
            );
        }

        if (filters.position) {
            result = result.filter(interview =>
                interview.position === filters.position
            );
        }

        if (filters.rating) {
            const ratingValue = parseInt(filters.rating);
            result = result.filter(interview => interview.rating === ratingValue);
        }

        if (filters.hasReports) {
            if (filters.hasReports === 'with-reports') {
                result = result.filter(interview => hasContentReports(interview.id!));
            } else if (filters.hasReports === 'without-reports') {
                result = result.filter(interview => !hasContentReports(interview.id!));
            }
        }

        return result;
    }, [allInterview, contentReports, filters]);

    useEffect(() => {
        onFilteredResults(getFilteredInterviews);
    }, [getFilteredInterviews, onFilteredResults]);

    const uniqueCompanies = useMemo(() => {
        if (!allInterview) return [];
        const companies = allInterview
            .map(interview => interview.company_name)
            .filter(Boolean)
            .filter((company, index, arr) => arr.indexOf(company) === index);
        return companies.sort();
    }, [allInterview]);

    const uniquePositions = useMemo(() => {
        if (!allInterview) return [];
        const positions = allInterview
            .map(interview => interview.position)
            .filter(Boolean)
            .filter((position, index, arr) => arr.indexOf(position) === index);
        return positions.sort();
    }, [allInterview]);

    const handleFilterChange = (filterName: keyof FilterState, value: string) => {
        setFilters(prev => ({
            ...prev,
            [filterName]: value
        }));
    };

    const resetFilters = () => {
        setFilters({
            companyName: '',
            position: '',
            rating: '',
            hasReports: ''
        });
    };

    const hasActiveFilters = Object.values(filters).some(filter => filter !== '');

    return (
        <>
            {/* ╫и╫з╫в ╫Ы╫Ф╫Ф */}
            {isOpen && (
                <div
                    className="fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300"
                    onClick={onClose}
                />
            )}

            {/* ╫Ч╫Ь╫Х╫а╫Щ╫к ╫Ф╫б╫Щ╫а╫Х╫Я */}
            <div className={`fixed top-0 right-0 h-full w-96 bg-gradient-to-b from-white to-gray-50 shadow-2xl z-50 transform transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : 'translate-x-full'
                }`} dir="rtl">

                {/* ╫Ы╫Х╫к╫и╫к ╫Ю╫в╫Х╫ж╫С╫к */}
                <div className="bg-gradient-to-r from-teal-500 to-teal-600 text-white p-6 shadow-lg">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="bg-white/20 p-2 rounded-lg">
                                <FaFilter className="w-5 h-5" />
                            </div>
                            <div>
                                <h3 className="text-xl font-bold">╫б╫Щ╫а╫Х╫Я ╫и╫Р╫Щ╫Х╫а╫Х╫к</h3>
                            </div>
                        </div>
                        <button
                            onClick={onClose}
                            className="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors duration-200"
                        >
                            <FaTimes className="w-5 h-5" />
                        </button>
                    </div>
                </div>

                {/* ╫к╫Х╫Ы╫Я ╫Ф╫б╫Щ╫а╫Х╫Я */}
                <div className="p-6 space-y-6 overflow-y-auto h-full pb-32">

                    {/* ╫б╫Щ╫а╫Х╫Я ╫Ь╫д╫Щ ╫Ч╫С╫и╫Ф */}
                    <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <label className="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-3">
                            <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                            ╫й╫Э ╫Ф╫Ч╫С╫и╫Ф
                        </label>
                        <select
                            value={filters.companyName}
                            onChange={(e) => handleFilterChange('companyName', e.target.value)}
                            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm bg-gray-50 hover:bg-white transition-colors"
                        >
                            <option value="">╫Ы╫Ь ╫Ф╫Ч╫С╫и╫Х╫к</option>
                            {uniqueCompanies.map(company => (
                                <option key={company} value={company}>{company}</option>
                            ))}
                        </select>
                    </div>

                    {/* ╫б╫Щ╫а╫Х╫Я ╫Ь╫д╫Щ ╫к╫д╫з╫Щ╫У */}
                    <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <label className="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-3">
                            <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                            ╫к╫д╫з╫Щ╫У
                        </label>
                        <select
                            value={filters.position}
                            onChange={(e) => handleFilterChange('position', e.target.value)}
                            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm bg-gray-50 hover:bg-white transition-colors"
                        >
                            <option value="">╫Ы╫Ь ╫Ф╫к╫д╫з╫Щ╫У╫Щ╫Э</option>
                            {uniquePositions.map(position => (
                                <option key={position} value={position}>{position}</option>
                            ))}
                        </select>
                    </div>

                    {/* ╫б╫Щ╫а╫Х╫Я ╫Ь╫д╫Щ ╫У╫Щ╫и╫Х╫Т */}
                    <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <label className="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-3">
                            <div className="w-2 h-2 bg-yellow-500 rounded-full"></div>
                            ╫У╫Щ╫и╫Х╫Т
                        </label>
                        <select
                            value={filters.rating}
                            onChange={(e) => handleFilterChange('rating', e.target.value)}
                            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm bg-gray-50 hover:bg-white transition-colors"
                        >
                            <option value="">╫Ы╫Ь ╫Ф╫У╫Щ╫и╫Х╫Т╫Щ╫Э</option>
                            <option value="1">тнР 1 ╫Ы╫Х╫Ы╫С</option>
                            <option value="2">тнРтнР 2 ╫Ы╫Х╫Ы╫С╫Щ╫Э</option>
                            <option value="3">тнРтнРтнР 3 ╫Ы╫Х╫Ы╫С╫Щ╫Э</option>
                            <option value="4">тнРтнРтнРтнР 4 ╫Ы╫Х╫Ы╫С╫Щ╫Э</option>
                            <option value="5">тнРтнРтнРтнРтнР 5 ╫Ы╫Х╫Ы╫С╫Щ╫Э</option>
                        </select>
                    </div>

                    {/* ╫б╫Щ╫а╫Х╫Я ╫Ь╫д╫Щ ╫У╫Щ╫Х╫Х╫Ч╫Щ╫Э */}
                    <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <label className="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-3">
                            <div className="w-2 h-2 bg-red-500 rounded-full"></div>
                            ╫У╫Щ╫Х╫Х╫Ч╫Щ╫Э ╫в╫Ь ╫к╫Х╫Ы╫Я
                        </label>
                        <select
                            value={filters.hasReports}
                            onChange={(e) => handleFilterChange('hasReports', e.target.value)}
                            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm bg-gray-50 hover:bg-white transition-colors"
                        >
                            <option value="">╫Ф╫Ы╫Ь</option>
                            <option value="with-reports">ЁЯЪи ╫в╫Э ╫У╫Щ╫Х╫Х╫Ч╫Щ╫Э</option>
                            <option value="without-reports">тЬЕ ╫Ь╫Ь╫Р ╫У╫Щ╫Х╫Х╫Ч╫Щ╫Э</option>
                        </select>
                    </div>

                </div>

                {/* ╫Ы╫д╫к╫Х╫и ╫Р╫Щ╫д╫Х╫б ╫С╫к╫Ч╫к╫Щ╫к */}
                <div className="absolute bottom-0 left-0 right-0 p-6 bg-white border-t border-gray-200 shadow-lg">
                    <button
                        onClick={resetFilters}
                        disabled={!hasActiveFilters}
                        className={`w-full px-6 py-3 rounded-lg text-sm font-semibold transition-all duration-200 ${hasActiveFilters
                                ? 'bg-gradient-to-r from-red-500 to-red-600 text-white hover:from-red-600 hover:to-red-700 shadow-md hover:shadow-lg transform hover:-translate-y-0.5'
                                : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            }`}
                    >
                        {hasActiveFilters ? ' ╫Р╫Щ╫д╫Х╫б ╫б╫Щ╫а╫Х╫Я' : '╫Р╫Щ╫Я ╫б╫Щ╫а╫Х╫Я ╫д╫в╫Щ╫Ь'}
                    </button>
                </div>
            </div>
        </>
    );
};
